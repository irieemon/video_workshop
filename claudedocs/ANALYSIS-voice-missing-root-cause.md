# Root Cause Analysis: Missing Character Vocals in Prompts
**Date:** 2025-10-23
**Status:** ✅ DIAGNOSED
**Severity:** HIGH - Affects character consistency

---

## Problem Statement

Character vocal characteristics are NOT appearing in generated Sora prompts despite multiple implementation attempts.

**User's Generated Prompt (Latest):**
```
Sound
Type: diegetic; Elements: bubbling soda, laughter; Levels: -18 LUFS; Exclusions: no score or added foley.
```

**Expected:**
```
Sound
Character vocals: Dad: sounds early 30s, warm tone; Lyle: sounds young child, playful tone, high pitch; Tom: sounds early teens, neutral tone.
Type: diegetic; Elements: bubbling soda, laughter...
```

---

## Timeline of Fixes Attempted

### Fix #1: Added Voice Integration Instructions (Earlier Today)
**Change:** Added instructions to include voice data in SOUND section
**File:** `lib/ai/agent-orchestrator.ts`
**Result:** ❌ Voice still missing
**Why Failed:** Instructions said "if provided" but didn't tell AI to EXTRACT

### Fix #2: Enhanced Extraction Instructions (1 hour ago)
**Change:** Explicit instructions to extract voice from character templates
**File:** `lib/ai/agent-orchestrator.ts`
**Instructions Added:**
```
- CRITICAL: Extract and include character vocal characteristics from character descriptions
  - Look for "Voice:" sections in character templates
  - Format: "Character vocals: [Name]: [voice details from template]..."
```
**Result:** ❌ Voice STILL missing in latest generation
**Why Failed:** Character templates DON'T HAVE voice data to extract

---

## Root Cause: Missing Voice Profile Data

### Evidence Chain:

1. **Database Trigger EXISTS and Works:**
   - File: `supabase-migrations/TRIGGER-WITH-DOUBLE-CAST.sql`
   - Lines 101-133: Generates "Voice:" section from voice_profile
   - ✅ Trigger is installed and active

2. **Fallback Function Includes Voice:**
   - File: `lib/types/character-consistency.ts:117-130`
   - ✅ Generates "Voice:" from voice_profile if present

3. **Character Templates Generated:**
   - API fetches `sora_prompt_template` from database
   - Template generated by trigger on INSERT/UPDATE
   - ✅ System is working correctly

4. **THE PROBLEM:**
   - **Dad, Lyle, and Tom likely have EMPTY voice_profile fields**
   - Database trigger: `IF vp IS NOT NULL AND vp != '{}'::jsonb THEN`
   - If voice_profile is `{}` (empty JSONB), NO voice section generated
   - If voice_profile is NULL, NO voice section generated

### Verification Needed:

```sql
SELECT
  name,
  voice_profile,
  sora_prompt_template
FROM series_characters
WHERE name IN ('Dad', 'Lyle', 'Tom');
```

**Expected Result:**
- `voice_profile` is likely `{}` or `NULL` for these characters
- `sora_prompt_template` does NOT contain "Voice:" section
- Therefore: AI has NO voice data to extract

---

## Why Previous Fixes Didn't Work

### Problem with All Implementations:

All our fixes assume voice data exists in character templates:
1. ✅ Database trigger works correctly
2. ✅ Synthesis instructions tell AI to extract voice
3. ❌ **BUT voice_profile fields are empty** - nothing to extract!

**Analogy:** We fixed the extraction pipeline perfectly, but the water source is dry.

---

## The Complete Solution

### Step 1: Populate Voice Profile Data ⏳

**Characters Need Voice Data:**

```sql
-- Dad
UPDATE series_characters
SET voice_profile = '{
  "age_sound": "early 30s",
  "accent": "neutral American",
  "pitch": "medium",
  "tone": "warm",
  "pace": "moderate",
  "energy": "moderate"
}'::jsonb
WHERE name = 'Dad';

-- Lyle
UPDATE series_characters
SET voice_profile = '{
  "age_sound": "young child",
  "accent": "neutral American",
  "pitch": "high",
  "tone": "playful",
  "pace": "fast",
  "energy": "high"
}'::jsonb
WHERE name = 'Lyle';

-- Tom
UPDATE series_characters
SET voice_profile = '{
  "age_sound": "early teens",
  "accent": "neutral American",
  "pitch": "medium",
  "tone": "neutral",
  "pace": "moderate",
  "energy": "moderate"
}'::jsonb
WHERE name = 'Tom';
```

**This will trigger:**
1. Database trigger fires on UPDATE
2. Regenerates `sora_prompt_template` with "Voice:" section
3. Future video generations will include voice data

### Step 2: Verify Template Generation ✅

After updating voice_profile:

```sql
SELECT
  name,
  sora_prompt_template
FROM series_characters
WHERE name IN ('Dad', 'Lyle', 'Tom');
```

**Should show:**
```
Dad: White early 30s... Voice: sounds early 30s, neutral American accent, warm tone, medium pitch. Performance: ...
```

### Step 3: Test New Video Generation ✅

Generate a new video with Dad, Lyle, Tom and verify SOUND section includes:
```
Sound
Character vocals: Dad: sounds early 30s, neutral American accent, warm tone; Lyle: sounds young child, playful tone, high pitch; Tom: sounds early teens, neutral accent, medium tone.
...
```

---

## Why This Wasn't Obvious

1. **Assumed Data Existed:** We knew voice_profile fields exist in schema
2. **Couldn't Query Database:** Connection issues prevented direct verification
3. **Multiple Compilation Successes:** Gave false confidence fixes were working
4. **AI Synthesis Complexity:** Hard to debug what AI receives vs what it generates

---

## Alternative: UI Solution

Instead of SQL updates, users can fill voice profiles through the Character Manager UI:

**File:** `components/series/character-consistency-form.tsx`

**Voice Profile Section:** Lines ~164-180 (already implemented)

**Fields Available:**
- Age Sound (e.g., "early 30s", "young child")
- Accent (e.g., "neutral American", "British RP")
- Pitch (high, medium, low)
- Tone (e.g., "warm", "playful", "authoritative")
- Pace (fast, moderate, slow)
- Energy (high, moderate, calm, low)

**User Action Required:**
1. Go to Series → Characters
2. Edit Dad, Lyle, Tom
3. Fill in Voice Profile section
4. Save (triggers template regeneration)

---

## Immediate Next Steps

1. **Verify Voice Profile Data:**
   - Check if Dad, Lyle, Tom have voice_profile populated
   - If empty, that's the root cause

2. **Populate Voice Data (Choose One):**
   - **Option A:** SQL updates (faster, direct)
   - **Option B:** UI form (user-friendly, permanent workflow)

3. **Test Generation:**
   - Create new video with all 3 characters
   - Verify SOUND section includes character vocals

4. **Document for Users:**
   - Add note to character creation: "Voice Profile required for vocal consistency"
   - Consider making voice_profile required when creating characters

---

## Technical Details

### Data Flow:

```
User Creates/Edits Character
       ↓
voice_profile field updated in database (currently empty for Dad/Lyle/Tom)
       ↓
Database trigger fires: update_character_sora_template()
       ↓
Checks: IF voice_profile NOT NULL AND != '{}'
       ↓
IF TRUE: Generates "Voice: sounds X, Y accent, Z tone..." ← THIS ISN'T HAPPENING
IF FALSE: Skips voice section ← THIS IS WHAT'S HAPPENING
       ↓
sora_prompt_template saved (without voice section)
       ↓
API fetches character templates
       ↓
Synthesis receives templates (no voice data to extract)
       ↓
AI cannot include what doesn't exist
       ↓
Final prompt has no character vocals ← USER'S ISSUE
```

### Fix Point:

The fix is at the SOURCE - populate voice_profile data, then everything downstream works automatically.

---

## Files Involved (For Reference)

**Database:**
- `supabase-migrations/TRIGGER-WITH-DOUBLE-CAST.sql` - Template generation logic
- `series_characters` table - voice_profile column

**Backend:**
- `lib/types/character-consistency.ts:117-130` - Fallback voice generation
- `app/api/agent/roundtable/route.ts:68-71` - Character template fetching

**AI Synthesis:**
- `lib/ai/agent-orchestrator.ts:504-512` - Voice extraction instructions (both modes)

**UI:**
- `components/series/character-consistency-form.tsx` - Voice profile input form

---

## Success Criteria

✅ **Implementation Complete** (all code changes done)
⏳ **Data Population Needed** (voice_profile fields empty)
⏳ **Testing Pending** (waiting for voice data to be added)

**When voice_profile populated:**
- Database trigger will regenerate templates with voice sections
- AI synthesis will extract voice from templates
- Generated prompts will include character vocals

---

**Status:** ✅ ROOT CAUSE IDENTIFIED
**Action Required:** Populate voice_profile data for Dad, Lyle, Tom
**Method:** SQL update OR UI form entry
**Expected Result:** Character vocals in all future prompts

---

*End of Root Cause Analysis - 2025-10-23*
